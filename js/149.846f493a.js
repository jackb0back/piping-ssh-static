(self["webpackChunkpiping_ssh_web"]=self["webpackChunkpiping_ssh_web"]||[]).push([[149,114],{7114:function(e){!function(t,r){e.exports=r()}(self,(function(){return(()=>{"use strict";var e={};return(()=>{var t=e;Object.defineProperty(t,"__esModule",{value:!0}),t.FitAddon=void 0,t.FitAddon=class{constructor(){}activate(e){this._terminal=e}dispose(){}fit(){const e=this.proposeDimensions();if(!e||!this._terminal||isNaN(e.cols)||isNaN(e.rows))return;const t=this._terminal._core;this._terminal.rows===e.rows&&this._terminal.cols===e.cols||(t._renderService.clear(),this._terminal.resize(e.cols,e.rows))}proposeDimensions(){if(!this._terminal)return;if(!this._terminal.element||!this._terminal.element.parentElement)return;const e=this._terminal._core,t=e._renderService.dimensions;if(0===t.css.cell.width||0===t.css.cell.height)return;const r=0===this._terminal.options.scrollback?0:e.viewport.scrollBarWidth,n=window.getComputedStyle(this._terminal.element.parentElement),s=parseInt(n.getPropertyValue("height")),i=Math.max(0,parseInt(n.getPropertyValue("width"))),a=window.getComputedStyle(this._terminal.element),o=s-(parseInt(a.getPropertyValue("padding-top"))+parseInt(a.getPropertyValue("padding-bottom"))),l=i-(parseInt(a.getPropertyValue("padding-right"))+parseInt(a.getPropertyValue("padding-left")))-r;return{cols:Math.max(2,Math.floor(l/t.css.cell.width)),rows:Math.max(1,Math.floor(o/t.css.cell.height))}}}})(),e})()}))},6149:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return H}});var n=r(3396),s=r(9242),i=r(4870),a=r(6849),o=r(9212),l=r(6526),c=r(7114),p=r(2529),d=r(4484);const u=p.u.knownHostKeyFingerprints,h=d.z.array(d.z.string());class w{trust(e){const t=[...this.getTrustedFingerPrints(),e];localStorage.setItem(u,JSON.stringify(t))}isTrusted(e){return this.getTrustedFingerPrints().includes(e)}getTrustedFingerPrints(){const e=JSON.parse(localStorage.getItem(u)??"[]"),t=h.safeParse(e);return t.success?t.data:[]}}var g=r(473),m=r(7865),v=r(4444),y=r(6008),f=r(5182),S=r(516),P=r(7274),_=(0,n.aZ)({__name:"PipingSsh",props:{pipingServerUrl:{},pipingServerHeaders:{},csPath:{},scPath:{},username:{},defaultSshPassword:{}},emits:["end"],setup(e,{emit:t}){const p=e,d=()=>r.e(537).then(r.t.bind(r,6537,23)),u=(0,i.iH)("connecting"),h=(0,i.iH)(),_=new w,b=(0,i.iH)(!1),H=(0,i.iH)((0,f.d)({pipingServerUrl:p.pipingServerUrl,pipingServerHeaders:p.pipingServerHeaders,csPath:p.csPath,scPath:p.scPath,sshServerPort:v.x.sshServerPortForHint()??22}));async function k(){const e=await Promise.all(g.aY.value.filter((e=>e.enabled)).map((async e=>{const t=await(0,m.UX)(e.privateKey),r={publicKey:e.publicKey,privateKey:e.privateKey,encrypted:t};return r})));return[...e.filter((e=>!e.encrypted)),...e.filter((e=>e.encrypted))]}function x(e){return g.aY.value.find((t=>t.sha256Fingerprint===e))}async function F(e){const t=x(e),r=await(0,m.p8)(t.publicKey),n=await(0,S.G)({title:"Passphrase",message:`(${t.name}) ${r}\nEnter passphrase for key`,inputType:"password",width:"60vw"});if(void 0===n)throw b.value=!0,new Error("passphrase input canceled");return n}async function C(){const{Terminal:e}=await d(),r=new e({cursorBlink:!0}),n=new c.FitAddon,s=new MessageChannel;async function i(){const e=n.proposeDimensions();void 0!==e&&(s.port1.postMessage({type:"resize",cols:e.cols,rows:e.rows}),n.fit())}r.loadAddon(n),r.open(h.value),window.addEventListener("resize",(()=>{i()}));const{readable:w,writable:g}=new TransformStream,v=(0,a.Z)(p.pipingServerUrl,p.csPath),y=(0,a.Z)(p.pipingServerUrl,p.scPath),f=new Headers(p.pipingServerHeaders);fetch(v,{method:"POST",headers:f,body:w,duplex:"half"}).then((e=>{console.log("postRes",e)}));const H=await fetch(y,{headers:f}),C={readable:H.body,writable:g},K=r.write;r.write=(...e)=>{K.apply(r,e),r.write=K,r.focus(),i(),i(),i(),i()};const M=new ReadableStream({start(e){r.onData((t=>{e.enqueue(t)}))}});window.addEventListener("beforeunload",(()=>{s.port1.postMessage({type:"disconnect"})}));try{let e=!1;const n=[C.readable,C.writable,M,s.port2];await(await(0,m.d0)()).doSsh(o.re({transport:C,termReadable:M,initialRows:r.rows,initialCols:r.cols,username:p.username,messagePort:s.port2,authKeySets:await k()},n),o.sj({termWrite(e){r.write(e)},async onPasswordAuth(){if(!e&&void 0!==p.defaultSshPassword)return e=!0,p.defaultSshPassword;const t=e?"try again.":"",r=await(0,S.G)({title:"Password",message:t,inputType:"password",width:"60vw"});if(void 0===r)throw b.value=!0,new Error("user aborted password input");return e=!0,r},getAuthPrivateKeyPassphrase:F,onAuthSigned:e=>{const t=x(e);(0,P.O)({icon:l.FCR,message:`Signed by ${t.name}`})},async onHostKey({key:e}){if(_.isTrusted(e.fingerprint))return!0;const t=await(0,S.G)({title:"New host",message:`${e.type} key fingerprint is ${e.fingerprint}\nAre you sure you want to continue connecting?`,placeholder:"yes/no/[fingerprint]",width:"60vw"});return"yes"===t||t===e.fingerprint?(_.trust(e.fingerprint),!0):(b.value=!0,!1)},onConnected(){u.value="connected"}})),(0,P.O)({icon:l.oL1,message:"Finished"}),t("end")}catch(T){if(b.value)return(0,P.O)({icon:l.M_e,message:"Canceled"}),void t("end");console.error("SSH error",T),alert(`SSH error: ${T}`),t("end")}}return(0,n.bv)((async()=>{await C()})),(e,t)=>{const r=(0,n.up)("v-progress-circular"),i=(0,n.up)("v-textarea"),a=(0,n.up)("v-col"),o=(0,n.up)("v-row"),l=(0,n.up)("v-container");return(0,n.wg)(),(0,n.iD)(n.HY,null,[b.value||"connecting"!==u.value?(0,n.kq)("",!0):((0,n.wg)(),(0,n.j4)(l,{key:0},{default:(0,n.w5)((()=>[(0,n.Wm)(o,null,{default:(0,n.w5)((()=>[(0,n.Wm)(a,{style:{"text-align":"center"}},{default:(0,n.w5)((()=>[(0,n.Wm)(r,{indeterminate:"",color:"secondary",size:200,width:2,style:{"margin-top":"3rem"}},{default:(0,n.w5)((()=>[(0,n.Uk)(" Connecting... ")])),_:1}),(0,n.Wm)(i,{label:"server-host command",modelValue:H.value,"onUpdate:modelValue":t[0]||(t[0]=e=>H.value=e),variant:"outlined",rows:"2",class:"text-grey",style:{"margin-top":"5rem"}},{"append-inner":(0,n.w5)((()=>[(0,n.Wm)(y.Z,{text:H.value},null,8,["text"])])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1})),(0,n.wy)((0,n._)("div",{ref_key:"terminal",ref:h,style:{width:"100%",height:"calc(100% - 15px)"}},null,512),[[s.F8,"connected"===u.value]])],64)}}});const b=_;var H=b}}]);
//# sourceMappingURL=149.846f493a.js.map